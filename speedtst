#!/usr/bin/env python3
import tkinter as tk
from tkinter import ttk
import subprocess
import threading
import sys
import os
from tkinter import font

class SpeedTestApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Internet Speed Test")
        self.root.geometry("400x500")  # Smaller and taller window
        self.root.resizable(False, False)
        self.root.configure(bg="#121212")  # Full dark mode background

        # Custom Fonts
        self.title_font = font.Font(family="Helvetica", size=20, weight="bold")
        self.result_font = font.Font(family="Helvetica", size=18, weight="bold")
        self.sub_font = font.Font(family="Helvetica", size=14)

        # Initialize variables
        self.download_speed = tk.StringVar(value="0.0 Mbps")
        self.upload_speed = tk.StringVar(value="0.0 Mbps")
        self.ping = tk.StringVar(value="0 ms")

        self.create_widgets()

    def create_widgets(self):
        # Title Label
        title_label = tk.Label(
            self.root,
            text="Speed Test",
            font=self.title_font,
            bg="#121212",
            fg="#ffffff"
        )
        title_label.pack(pady=(20, 10))

        # Loading Animation Canvas
        self.loading_canvas = tk.Canvas(self.root, width=120, height=120, bg="#121212", highlightthickness=0)
        self.loading_canvas.pack(pady=10)
        self.loading_angle = 0
        self.animate_loading()

        # Start Test Button
        self.start_button = tk.Button(
            self.root,
            text="Start Test",
            font=("Helvetica", 14),
            bg="#bb86fc",  # Vibrant purple for contrast
            fg="#121212",
            activebackground="#3700b3",
            activeforeground="#ffffff",
            relief="flat",
            command=self.start_test,
            padx=20,
            pady=10,
            borderwidth=0,
            highlightthickness=0
        )
        self.start_button.pack(pady=10)

        # Results Frame
        self.results_frame = tk.Frame(self.root, bg="#121212")
        self.results_frame.pack(pady=20)

        # Download Icon and Label
        download_icon = tk.Label(self.results_frame, text="‚¨áÔ∏è", font=("Arial", 18), bg="#121212", fg="#bb86fc")
        download_icon.grid(row=0, column=0, padx=10, pady=5, sticky="w")
        self.download_label = tk.Label(
            self.results_frame,
            textvariable=self.download_speed,
            font=self.result_font,
            bg="#121212",
            fg="#bb86fc"
        )
        self.download_label.grid(row=0, column=1, padx=10, pady=5, sticky="w")

        # Upload Icon and Label
        upload_icon = tk.Label(self.results_frame, text="‚¨ÜÔ∏è", font=("Arial", 18), bg="#121212", fg="#bb86fc")
        upload_icon.grid(row=1, column=0, padx=10, pady=5, sticky="w")
        self.upload_label = tk.Label(
            self.results_frame,
            textvariable=self.upload_speed,
            font=self.result_font,
            bg="#121212",
            fg="#bb86fc"
        )
        self.upload_label.grid(row=1, column=1, padx=10, pady=5, sticky="w")

        # Ping Icon and Label
        ping_icon = tk.Label(self.results_frame, text="üèì", font=("Arial", 18), bg="#121212", fg="#bb86fc")
        ping_icon.grid(row=2, column=0, padx=10, pady=5, sticky="w")
        self.ping_label = tk.Label(
            self.results_frame,
            textvariable=self.ping,
            font=self.result_font,
            bg="#121212",
            fg="#bb86fc"
        )
        self.ping_label.grid(row=2, column=1, padx=10, pady=5, sticky="w")

    def animate_loading(self):
        # Create a rotating arc with gradient effect for the loading animation
        self.loading_canvas.delete("all")
        self.loading_canvas.create_arc(
            10, 10, 110, 110,
            start=self.loading_angle,
            extent=90,
            outline="#bb86fc",
            width=8,
            style="arc"
        )
        self.loading_angle = (self.loading_angle + 10) % 360
        self.root.after(50, self.animate_loading)

    def start_test(self):
        # Disable the button and reset results
        self.start_button.config(state="disabled")
        self.download_speed.set("0.0 Mbps")
        self.upload_speed.set("0.0 Mbps")
        self.ping.set("0 ms")

        # Run the speed test in a separate thread
        threading.Thread(target=self.run_speedtest).start()

    def run_speedtest(self):
        try:
            # Use the virtual environment's Python to run speedtest-cli
            venv_python = os.path.join(os.getcwd(), "venv", "bin", "python")
            result = subprocess.run(
                [venv_python, '-m', 'speedtest', '--simple'],
                capture_output=True,
                text=True,
                check=True
            )
            output = result.stdout.strip()

            # Parse the output
            results = {}
            for line in output.split("\n"):
                key, value = line.split(": ")
                results[key.lower()] = value

            # Update the GUI with parsed results
            self.root.after(0, self.update_result, results)
        except Exception as e:
            self.root.after(0, self.update_result, {"error": str(e)})

    def update_result(self, results):
        # Re-enable the button
        self.start_button.config(state="normal")

        if "error" in results:
            self.download_speed.set("Error")
            self.upload_speed.set("Error")
            self.ping.set("Error")
        else:
            # Animate results with fade-in effect
            self.animate_fade_in(self.download_label, f"{results.get('download', '0.0')} Mbps")
            self.animate_fade_in(self.upload_label, f"{results.get('upload', '0.0')} Mbps")
            self.animate_fade_in(self.ping_label, f"{results.get('ping', '0')} ms")

    def animate_fade_in(self, widget, target_value, duration=1000, steps=50):
        """Animate a widget's text with a fade-in effect."""
        current_alpha = 0
        step_size = 255 // steps
        delay = duration // steps

        def update(step):
            nonlocal current_alpha
            if step <= steps:
                current_alpha += step_size
                widget.config(fg=f"#{current_alpha:02x}{current_alpha:02x}{current_alpha:02x}")
                widget.after(delay, lambda: update(step + 1))
            else:
                widget.config(text=target_value, fg="#bb86fc")

        update(0)

def main():
    root = tk.Tk()
    app = SpeedTestApp(root)
    root.mainloop()

if __name__ == "__main__":
    main()
